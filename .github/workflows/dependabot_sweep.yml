name: Dependabot Manual Sweep

on:
  # Trigger: it won't run unless we click the button
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Enable Auto-Merge for all open Dependabot PRs
        run: |
          echo "Fetching open Dependabot PRs..."

          # Get the list of URLs
          PR_URLS=$(gh pr list --author "dependabot[bot]" --state open --json url --jq '.[].url')

          if [ -z "$PR_URLS" ]; then
            echo "No open Dependabot PRs found. Nothing to do!"
            exit 0
          fi

          echo "Found PRs. Enabling auto-merge..."
          echo "$PR_URLS" | xargs -I {} gh pr merge --auto --squash "{}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
